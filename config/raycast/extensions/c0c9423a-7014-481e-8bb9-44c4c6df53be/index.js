"use strict";var A=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var me=Object.getOwnPropertyNames;var fe=Object.prototype.hasOwnProperty;var he=(e,t)=>{for(var i in t)A(e,i,{get:t[i],enumerable:!0})},ge=(e,t,i,c)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of me(t))!fe.call(e,l)&&l!==i&&A(e,l,{get:()=>t[l],enumerable:!(c=ue(t,l))||c.enumerable});return e};var Pe=e=>ge(A({},"__esModule",{value:!0}),e);var xe={};he(xe,{default:()=>ee});module.exports=Pe(xe);var s=require("@raycast/api"),Q=require("child_process");var ye=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],be=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Ne=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Se=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],L=(e,t,i)=>{let c=e;return typeof t=="string"||Array.isArray(t)?c=e.toLocaleString(t,i):(t===!0||i!==void 0)&&(c=e.toLocaleString(void 0,i)),c};function T(e,t){if(!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);t={bits:!1,binary:!1,space:!0,...t};let i=t.bits?t.binary?Se:Ne:t.binary?be:ye,c=t.space?" ":"";if(t.signed&&e===0)return` 0${c}${i[0]}`;let l=e<0,g=l?"-":t.signed?"+":"";l&&(e=-e);let o;if(t.minimumFractionDigits!==void 0&&(o={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(o={maximumFractionDigits:t.maximumFractionDigits,...o}),e<1){let B=L(e,t.locale,o);return g+B+c+i[0]}let f=Math.min(Math.floor(t.binary?Math.log(e)/Math.log(1024):Math.log10(e)/3),i.length-1);e/=(t.binary?1024:1e3)**f,o||(e=e.toPrecision(3));let S=L(Number(e),t.locale,o),C=i[f];return g+S+c+C}var N=require("react");var $=require("react"),Ce=()=>{};function Ie(e,t){let i=(0,$.useRef)(Ce);(0,$.useEffect)(()=>{i.current=e},[e]),(0,$.useEffect)(()=>{if(i.current(),(t??0)>0){let l=Math.max(t??0,1e3),g=setInterval(()=>i.current(),l);return()=>clearInterval(g)}},[t])}var k=Ie;var v=process.platform,x=v==="darwin",m=v==="win32";function R(e){return Buffer.from(e,"utf16le").toString("base64")}var we=`
$result = Get-Process | Where-Object { $_.Id -ne 0 } | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.Id
    name = $_.ProcessName
    cpu = 0
    mem = [math]::Round($_.WorkingSet64 / 1KB, 0)
    path = if ($_.Path) { $_.Path } else { '' }
  }
}
$result | ConvertTo-Json -Compress
`,$e=`
$cpuCores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
$processes = Get-CimInstance Win32_PerfFormattedData_PerfProc_Process | Where-Object { $_.IDProcess -ne 0 -and $_.Name -ne '_Total' -and $_.Name -ne 'Idle' }
$result = $processes | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.IDProcess
    cpu = [math]::Round($_.PercentProcessorTime / $cpuCores, 1)
  }
}
$result | ConvertTo-Json -Compress
`;function K(){return m?`powershell -EncodedCommand ${R(we)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function O(){return m?`powershell -EncodedCommand ${R($e)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function U(e,t=!1){return m?t?`taskkill /F /PID ${e}`:`taskkill /PID ${e}`:t?`zsh -c 'sudo kill -9 ${e}'`:`kill -9 ${e}`}function G(e){let t=e.trim();if(!t)return null;let i=t.match(/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/);if(!i)return null;let[,c,l,g,o,f]=i;return{id:parseInt(c),pid:parseInt(l),cpu:parseFloat(g),mem:parseInt(o),path:f,processName:f.match(/[^/]*$/)?.[0]??""}}function j(e){try{let t=JSON.parse(e);return(Array.isArray(t)?t:[t]).map(c=>({id:c.pid,pid:0,cpu:c.cpu,mem:c.mem,path:c.path||"",processName:c.name||""}))}catch{return console.error("Failed to parse Windows process output"),[]}}function Y(e){let t=new Map;try{let i=JSON.parse(e),c=Array.isArray(i)?i:[i];for(let l of c)l?.pid&&t.set(l.pid,l.cpu??0)}catch{console.error("Failed to parse Windows performance output")}return t}function z(e){if(x)return e.includes(".prefPane")?"prefPane":e.includes(".app/")?"app":"binary";if(m){let t=e.toLowerCase();return t.endsWith(".exe")&&(t.includes("program files")||t.includes("applications"))?"app":"binary"}return"binary"}function H(e,t){return x?e.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]:m?t.replace(/\.exe$/i,""):t}function J(e){return x?e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns":m?e.type==="app"?{fileIcon:e.path}:"\u{1F5A5}\uFE0F":"\u2699\uFE0F"}function Z(e){return x&&e?{title:"Failed to Force Kill Process",message:"Please ensure that touch ID/password prompt is enabled for sudo",helpUrl:"https://dev.to/siddhantkcode/enable-touch-id-authentication-for-sudo-on-macos-sonoma-14x-4d28"}:m&&e?{title:"Failed to Force Kill Process",message:"Administrative privileges may be required. Try running as administrator."}:{title:"Failed to Kill Process",message:"The process could not be terminated. It may have already exited or require elevated privileges."}}var F=require("child_process");var q={maxBuffer:10*1024*1024};async function X(){return new Promise((e,t)=>{(0,F.exec)(K(),q,(i,c)=>{if(i){t(i);return}let g=(m?j(c):c.split(`
`).map(G).filter(Boolean)).filter(o=>o?.processName).map(o=>{let f=o.path||"",S=o.processName||"",C=z(f);return{id:o.id||0,pid:o.pid||0,cpu:o.cpu||0,mem:o.mem||0,type:C,path:f,processName:S,appName:C==="app"?H(f,S):void 0}}).filter(o=>o.processName!=="");e(g)})})}async function V(){return m?new Promise(e=>{(0,F.exec)(O(),q,(t,i)=>{if(t){console.error("Failed to fetch CPU performance data:",t),e(new Map);return}e(Y(i))})}):new Map}var u=require("react/jsx-runtime");function ee(){let[e,t]=(0,N.useState)([]),[i,c]=(0,N.useState)([]),[l,g]=(0,N.useState)(""),o=(0,s.getPreferenceValues)(),f=o.shouldSearchInPaths,S=o.shouldSearchInPid,C=o.shouldPrioritizeAppsWhenFiltering,B=o.shouldShowPID,te=o.shouldShowPath,re=+o.refreshDuration,se=o.closeWindowAfterKill,M=o.clearSearchBarAfterKill,ie=o.goToRootAfterKill,[E,oe]=(0,N.useState)(o.sortByMem?"memory":"cpu"),[w,ne]=(0,N.useState)(o.aggregateApps),[_,ae]=(0,N.useState)(new Map),D=()=>{X().then(r=>{m&&_.size>0&&(r=r.map(n=>{let a=_.get(n.id);return a!==void 0?{...n,cpu:a}:n})),t(r),m&&V().then(n=>{n.size>0&&(ae(n),t(a=>a.map(b=>{let P=n.get(b.id);return P!==void 0?{...b,cpu:P}:b})))})}).catch(r=>{console.error("Failed to fetch processes:",r),(0,s.showToast)({title:"Failed to fetch processes",style:s.Toast.Style.Failure,message:r instanceof Error?r.message:"Unknown error"})})};k(D,re),(0,N.useEffect)(()=>{let r=e;w&&(r=pe(r)),r.sort((n,a)=>E==="memory"?n.mem>a.mem?-1:1:n.cpu>a.cpu?-1:1),c(r)},[e,E,w]);let ce=r=>J(r),W=async(r,n=!1)=>{let a=r.processName==="-"?`process ${r.id}?`:r.processName;if(!await(0,s.confirmAlert)({title:`${n?"Force ":""}Kill ${a}?`,rememberUserChoice:!0})){(0,s.showToast)({title:`Cancelled Killing ${a}`,style:s.Toast.Style.Failure});return}let b=U(r.id,n);(0,Q.exec)(b,P=>{if(P){let y=Z(n);n&&y.helpUrl?(0,s.confirmAlert)({title:y.title,message:y.message,primaryAction:{title:"Open Help",onAction:()=>(0,s.open)(y.helpUrl)}}):(0,s.showToast)({title:y.title,message:y.message,style:s.Toast.Style.Failure});return}(0,s.showToast)({title:`Killed ${a}`,style:s.Toast.Style.Success})}),t(i.filter(P=>P.id!==r.id)),se&&(0,s.closeMainWindow)(),ie&&(0,s.popToRoot)({clearSearchBar:M}),M&&(0,s.clearSearchBar)({forceScrollToTop:!0})},le=r=>{let n=[];return r.type==="aggregatedApp"&&r.appName!=null&&n.push(r.appName),B&&n.push(r.id.toString()),te&&n.push(r.path),n.join(" - ")},pe=r=>{let n=Array(),a=new Map;a.set(1,{process:{id:1},childNodes:[]});let b=Array();r.forEach(p=>{if(p.type==="app"){b.push(p.id);let h=a.get(p.id);h==null?(h={process:p,childNodes:[]},a.set(p.id,h)):h.process=p;let d=a.get(p.pid);if(d==null)d={process:void 0,childNodes:[h]},a.set(p.pid,d);else if(d.process==null)d.childNodes.push(h);else{let I;for(;d?.process!=null&&d.process.pid!==1&&(I=a.get(d.process.pid))!=null;)d=I;d?.childNodes.push(h)}d.process?.id!==1&&(d.childNodes=d.childNodes.concat(h.childNodes),h.childNodes=[])}else n.push(p)});let P=a.get(1)?.childNodes,y=Array();return P?.forEach(p=>{if(p.process==null)return;y.push(p.process.id);let h=p.childNodes.map(d=>d.process?.id).filter(d=>d!=null);y=y.concat(h),n.push({id:p.process.id,pid:p.process.pid,cpu:(p.childNodes?.reduce((d,I)=>d+(I.process?.cpu??0),0)??0)+p.process.cpu,mem:(p.childNodes?.reduce((d,I)=>d+(I.process?.mem??0),0)??0)+p.process.mem,type:"aggregatedApp",path:p.process.path,processName:p.process.processName,appName:p.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),n},de=i.length;return(0,u.jsx)(s.List,{isLoading:i.length===0,searchBarPlaceholder:"Filter by name",onSearchTextChange:r=>g(r),searchBarAccessory:(0,u.jsx)(s.List.Dropdown,{tooltip:"Filter",storeValue:!0,onChange:r=>oe(r),children:(0,u.jsxs)(s.List.Dropdown.Section,{title:"Sort By",children:[(0,u.jsx)(s.List.Dropdown.Item,{title:"CPU Usage",value:"cpu"}),(0,u.jsx)(s.List.Dropdown.Item,{title:"Memory Usage",value:"memory"})]})}),children:(0,u.jsx)(s.List.Section,{title:"Processes",subtitle:`${de} running`,children:i.filter(r=>{if(l==="")return!0;let n=r.processName.toLowerCase().includes(l.toLowerCase()),a=f&&r.path.toLowerCase().match(new RegExp(`.+${l}.*\\.[app|framework|prefpane]`,"ig"))!=null,b=S&&r.id.toString().includes(l),P=r.type==="aggregatedApp"&&r.appName?.toLowerCase().includes(l.toLowerCase());return n||a||b||P}).sort((r,n)=>{if(C){let a=["app","aggregatedApp"];if(a.includes(r.type)&&!a.includes(n.type))return-1;if(!a.includes(r.type)&&a.includes(n.type))return 1}return 0}).map((r,n)=>{let a=ce(r);return(0,u.jsx)(s.List.Item,{title:r.processName,subtitle:le(r),icon:a,accessories:[{text:`${r.cpu.toFixed(2)}%`,icon:{source:"cpu.svg",tintColor:s.Color.PrimaryText},tooltip:"% CPU"},{text:T(r.mem*1024),icon:{source:"memorychip.svg",tintColor:s.Color.PrimaryText},tooltip:"Memory"}],actions:(0,u.jsxs)(s.ActionPanel,{children:[(0,u.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>W(r)}),(0,u.jsx)(s.Action,{title:"Force Kill",icon:s.Icon.XMarkCircle,onAction:()=>W(r,!0)}),r.path==null?null:(0,u.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:r.path}),(0,u.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>D()}),(0,u.jsx)(s.Action,{title:`${w?"Disable":"Enable"} Aggregating Apps`,icon:s.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{ne(!w),(0,s.showToast)({title:`${w?"Disabled":"Enabled"} aggregating apps`})}})]})},n)})})})}
